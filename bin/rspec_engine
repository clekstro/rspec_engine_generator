#!/usr/bin/env ruby

require 'thor'

class RspecEngine < Thor
  include Thor::Actions

  option :mountable, type: :boolean, default: true, desc: "choose whether to make the engine mountable or not (if false, engine is --full)"
  desc "new NAME", "Build a new rspec-ready engine named NAME"
  def new(name)
    command = %{rails plugin new #{name} #{options[:mountable] ? '--mountable ' : '--full'}--skip-test-unit --skip-bundle --dummy-path=spec/dummy}
    system command
    inside name do
      run 'git init && git add . && git commit -m"Base engine"'
      insert_into_file "#{name}.gemspec", :after => 's.add_development_dependency "sqlite3"' do
        %{\n  s.add_development_dependency "rspec-rails"\n  s.add_development_dependency "capybara"}
      end
      run "bundle install"
      run "rails g rspec:install"
      gsub_file 'spec/spec_helper.rb', /..\/config\/environment/, 'dummy/config/environment'
      insert_into_file "Rakefile", after: "load 'rails/tasks/engine.rake'" do
        %{\n\nrequire 'rspec/core/rake_task'\nRSpec::Core::RakeTask.new(:spec)\ntask :default => :spec}
      end
      run 'git add . && git commit -m"added rspec"'
      empty_directory "spec/requests"
      create_file "spec/requests/requests_helper.rb", "require 'spec_helper.rb'\nrequire 'capybara/rspec'"
      create_file "spec/requests/root_spec.rb", <<-SPEC.gsub(/^ {8}/, '')
        require 'requests/requests_helper'

        feature "Root", %q{
          In order to provide base functionality
          As a user
          I want to view the root url
        } do

          background do
          end

          scenario "View " do
            visit '/'
            page.should have_content('Welcome')
          end
        end
      SPEC
      run 'git add . && git ci -am"installed capybara"'
      insert_into_file 'spec/dummy/config/routes.rb', " root to: 'home#index'\n", before: 'end'
      # generate a home controller and place to link off to engine from
      inside 'spec/dummy' do
        run "rails g controller Home index"
        create_file 'app/views/home/index.html.erb', force: true do
          content = <<-INDEX.gsub(/^ {12}/, '')
            <h1>Welcome to the Dummy app for #{name}</h1>
            <ul>
              <li><%= link_to "View #{name} dashboard", #{name}_path %></li>
            </ul>
          INDEX
        end
      end

      # now create a basic dashboard for engine
      run "rails g controller Dashboard index"
      insert_into_file 'config/routes.rb', " root to: 'dashboard#index'\n", before: 'end'
      create_file "app/views/#{name}/dashboard/index.html.erb", force: true do
        content = <<-INDEX.gsub(/^ {10}/, '')
          <h1>Welcome to an example Dashboard for #{name}</h1>
        INDEX
      end
    end
  end
end

RspecEngine.start(ARGV)
